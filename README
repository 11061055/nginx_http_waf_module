## 背景


多数服务器有自己的防火墙 ( 如 iptables )，而防火墙一般处于网络层或者运输层，

是业务无感知的，能做一些通用的风险规则，比如 IP 白名单，能做的事有限。而业务

需要的风险规则相当复杂，或者说业务不仅需要网络层和运输层的通用风险规则，也需

要应用层的风险规则。


## 设计


—————————————————————————————————————————————————————————————————————

服务器部署：


          用户 ----------> 代理网关集群 ----------> 业务服务器集群
          
—————————————————————————————————————————————————————————————————————          
  
  
大多数服务器部署方式如上，以一种最小成本的方式，既做应用层风控，又尽量不影响业

务，也就说风控尽量和业务隔离开来，各自处理各自的。


一种方案就是，设置一个风控集群，所有线上流量首先经过风控集群，如果满足风险要

求，就将流量转发到业务服务器集群，否则请求将被拒绝掉。简单点说，需要一个工具

将线上流量拷贝到风控集群，风控集群处理并返回风险判断，若无风险则继续后续流程。


—————————————————————————————————————————————————————————————————————

服务器部署改进：


          用户 ----------> 代理网关集群 ----------> 业务服务器集群
                                \                       /
                                 \                     /
                                  \                   /
                                   \                 /
                                    \               /
                                         风控集群
                                   
                               
—————————————————————————————————————————————————————————————————————


在这种模式下，风控集群既接收线上流量的拷贝，完成一些业务不相关或者弱相关的风

险规则；又接收业务服务器发出的业务强相关风险判断。也就是说，风控集群做了基本

所有的风险判断，包含所有风险判断规则，并且与业务服务器集群完全隔离开。


每当有请求发往代理网关集群的时候，网关集群一方面将请求发往风控集群做处理，另

一方面从风控集群接收风险判断，如果风险等级处于正常水平，再往业务服务器转发。


## 实现


代理集群以 nginx 为例，需要一个轻量级模块，将请求拷贝到风控集群，并且接收风控

集群的风险判断。ngx_http_waf_module 模块实现上述功能。


—————————————————————————————————————————————————————————————————————

风险等级 (WAF_LEVEL) 表述如下：

            WAF_LEVEL0  :  未知 风险等级，用于初始化设置
            
            WAF_LEVEL1  :  正常 风险等级，请求可以被放行
            
            WAF_LEVEL2  :  紧急 风险等级，请求不能被放行
            
 —————————————————————————————————————————————————————————————————————
 
 
 —————————————————————————————————————————————————————————————————————
 
 
 Nginx 配置项如下：
 
 
                 Syntax:	waf_target uri | off;
                 Default:	waf_target off;
                 Context:	http, server, location
 

—————————————————————————————————————————————————————————————————————


—————————————————————————————————————————————————————————————————————


Nginx 配置例子如下：


http {
    
    server {

	      waf_target /waf_target_common;

        location = /login {
        }
        
        location ~* .(jpg|jpeg)$ {
        }

        location = /heartbeat {

	        waf_target /waf_tartget_heartbeat;
        }

        location = /50x.html {

            waf_target off;
        }


        ######### 通用 waf 风控集群
        location = /waf_target_common {
            proxy_pass http://xxx.xxx.xxx.xxx$request_uri;
        }

        ######### 心跳 waf 风控集群
        location = /waf_target_heartbeat {
            proxy_pass http://yyy.yyy.yyy.yyy$request_uri;
        }
    }
}


—————————————————————————————————————————————————————————————————————


在上面的配置中，login jpg jpeg 路径都会走 通用 waf 风控集群，heaetbet 路径

会走 心跳 waf 风控集群，50x.html 路径不走任何风控集群。


## 参考


相关模块：

ngx_http_mirror_module   模块： 后台异步方式拷贝请求

http_auth_request_module 模块： 验证
